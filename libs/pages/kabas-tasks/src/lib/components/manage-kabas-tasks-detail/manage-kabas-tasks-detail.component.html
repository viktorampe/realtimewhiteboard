<campus-page-bar *ngIf="task$ | async as task">
  <ng-container
    *ngIf="selectedTaskEduContents.length === 0; else contentSelected"
  >
    <campus-button
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      ><span>Lesmateriaal toevoegen</span></campus-button
    >
    <campus-button
      *ngIf="!task.isPaperTask"
      class="shared-header__contextual__button smallIcon"
      iconClass="results"
      ><span>Resultaten bekijken</span></campus-button
    >
    <campus-button
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      ><span>Doelenmatrix</span></campus-button
    >
    <campus-button
      *ngIf="task.isPaperTask"
      class="shared-header__contextual__button smallIcon"
      iconClass="print"
      (click)="clickPrintTask()"
      ><span>Print</span></campus-button
    >
  </ng-container>

  <ng-template #contentSelected>
    <campus-button
      *ngIf="selectedTaskEduContents.length === 1"
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      (click)="preview(selectedTaskEduContents[0], !!task.isPaperTask)"
      ><span>{{
        task.isPaperTask ? 'Voorbeeld' : 'Openen'
      }}</span></campus-button
    >
    <campus-button
      *ngIf="task.isPaperTask"
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      ><span>Print</span></campus-button
    >
    <campus-button
      class="shared-header__contextual__button smallIcon"
      iconClass="delete"
      (click)="clickRemoveTaskEduContents(selectedTaskEduContents)"
      ><span>Verwijderen</span></campus-button
    >
  </ng-template>
</campus-page-bar>
<ng-template #noTask>Deze taak is niet beschikbaar.</ng-template>

<campus-side-sheet
  #taskSidesheet
  *ngIf="task$ | async as task; else noTask"
  [isOpenOnInit]="true"
>
  <campus-side-sheet-header>
    <ng-container [ngSwitch]="selectedTaskEduContents.length">
      <ng-container *ngSwitchCase="0">Over deze taak:</ng-container>
      <ng-container *ngSwitchDefault>Over dit lesmateriaal:</ng-container>
    </ng-container>
  </campus-side-sheet-header>

  <campus-side-sheet-body>
    <div class="manage-kabas-tasks-detail__info">
      <ng-container
        *ngIf="selectedTaskEduContents.length === 0; else contentDetails"
      >
        <campus-content-editable
          [text]="task.name"
          [placeholder]="'Titel'"
          [required]="true"
          [icon]="'edit'"
          (textChanged)="updateTitle(task, $event)"
          data-cy="task-title"
          [relatedItem]="task"
          class="manage-kabas-tasks-detail__info__title"
        ></campus-content-editable>

        <campus-content-editable
          [text]="task.description"
          [placeholder]="'Omschrijving'"
          [multiline]="true"
          [required]="false"
          [icon]="'edit'"
          (textChanged)="updateDescription(task, $event)"
          [relatedItem]="task"
          class="manage-kabas-tasks-detail__info__description"
        ></campus-content-editable>

        <p>{{ task.learningArea.name }}</p>
        <ng-template #showDates>
          <p *ngIf="task.startDate"
            >{{ task.startDate | date: 'dd-MM-yy' }} -
            {{ task.endDate | date: 'dd-MM-yy' }}</p
          >
        </ng-template>

        <div class="manage-kabas-tasks-detail__info__container">
          <div>
            <campus-button
              class="manage-kabas-tasks-detail__info__add-assignees"
              (click)="openAssigneeModal()"
              >+</campus-button
            >
            Leerlingen toevoegen voor deze taak:
          </div>
          <div>
            <span
              *ngFor="let assignee of task.assignees"
              class="manage-kabas-tasks-detail__info__assignee"
              [matTooltip]="
                (assignee.start | date: 'dd-MM-yy') +
                ' - ' +
                (assignee.end | date: 'dd-MM-yy')
              "
              [class.classgroup]="
                assignee.type === assigneeTypesEnum.CLASSGROUP
              "
              [class.group]="assignee.type === assigneeTypesEnum.GROUP"
              [class.student]="assignee.type === assigneeTypesEnum.STUDENT"
              >{{ assignee.label }}
              <mat-icon
                svgIcon="close"
                (click)="removeAssignee(task, assignee)"
              ></mat-icon
            ></span>
          </div>
        </div>

        <ng-container *ngIf="task.isPaperTask; else showDates">
          <div
            (click)="printTask(task, true)"
            class="manage-kabas-tasks-detail__info__link manage-kabas-tasks-detail__info__link--print"
            [class.manage-kabas-tasks-detail__info__link--disabled]="
              !task.assignees.length
            "
            [matTooltip]="
              !task.assignees.length
                ? 'Deze taak is aan niemand toegekend.'
                : ''
            "
            matTooltipPosition="before"
          >
            <mat-icon
              svgIcon="print"
              class="manage-kabas-tasks-detail__info__link__icon"
            ></mat-icon
            ><span class="manage-kabas-tasks-detail__info__link__label"
              >Afdrukken met namen</span
            ></div
          >
          <div
            (click)="printTask(task, false)"
            class="manage-kabas-tasks-detail__info__link manage-kabas-tasks-detail__info__link--print"
            ><mat-icon
              svgIcon="print"
              class="manage-kabas-tasks-detail__info__link__icon"
            ></mat-icon
            ><span class="manage-kabas-tasks-detail__info__link__label"
              >Afdrukken zonder namen</span
            ></div
          >
          <div
            (click)="printSolution(task)"
            class="manage-kabas-tasks-detail__info__link manage-kabas-tasks-detail__info__link--print"
            [class.manage-kabas-tasks-detail__info__link--disabled]="
              !task.hasSolutionFiles
            "
            [matTooltip]="
              !task.hasSolutionFiles
                ? 'Het lesmateriaal in deze taak bevat geen correctiesleutels.'
                : ''
            "
            ><mat-icon
              svgIcon="print"
              class="manage-kabas-tasks-detail__info__link__icon"
            ></mat-icon
            ><span class="manage-kabas-tasks-detail__info__link__label"
              >Correctiesleutel afdrukken</span
            ></div
          >
        </ng-container>
        <campus-button primary>+ Lesmateriaal toevoegen</campus-button>
        <campus-button
          danger
          (click)="clickDeleteTask(task)"
          [disabled]="isActiveTask(task)"
        >
          Verwijder taak
        </campus-button>
      </ng-container>

      <ng-template #contentDetails>
        <div
          class="manage-kabas-tasks-detail__info__container"
          *ngFor="let selectedContent of selectedTaskEduContents"
          data-cy="educontent-detail"
        >
          <ng-container
            *ngIf="
              selectedContent.eduContent.publishedEduContentMetadata as metadata
            "
          >
            <h2>{{ metadata.title }}</h2>
            <p>{{ metadata.description }}</p>
            <div *ngIf="metadata.learningArea">{{
              metadata.learningArea.name
            }}</div>
            <div *ngIf="metadata.methods" class="list-split">
              <span *ngFor="let method of metadata.methods">{{
                method.name
              }}</span>
            </div>
            <campus-button
              (click)="preview(selectedContent, !!task.isPaperTask)"
              >Preview</campus-button
            >
          </ng-container>
        </div>

        <div
          *ngIf="!task.isPaperTask"
          class="manage-kabas-tasks-detail__info__container"
        >
          <mat-radio-group
            *ngIf="selectedTaskEduContents.length === 1; else multipleSelected"
            [value]="selectedTaskEduContents[0].required"
            (change)="
              setTaskEduContentsRequiredState(
                selectedTaskEduContents,
                $event.value
              )
            "
          >
            <mat-radio-button
              [checked]="selectedTaskEduContents[0].required"
              [value]="true"
              >Moetje</mat-radio-button
            >
            <br /><mat-radio-button
              [checked]="!selectedTaskEduContents[0].required"
              [value]="false"
              >Magje</mat-radio-button
            >
          </mat-radio-group>
          <ng-template #multipleSelected>
            <div
              class="manage-kabas-tasks-detail__info__container__change-all-buttons"
            >
              <campus-button
                (click)="
                  setTaskEduContentsRequiredState(selectedTaskEduContents, true)
                "
                >Alles moetje</campus-button
              >
              <campus-button
                (click)="
                  setTaskEduContentsRequiredState(
                    selectedTaskEduContents,
                    false
                  )
                "
                >Alles magje</campus-button
              >
            </div>
          </ng-template>
        </div>

        <campus-button
          danger
          [disabled]="isActiveTask(task)"
          (click)="clickRemoveTaskEduContents(selectedTaskEduContents)"
          >Verwijder lesmateriaal</campus-button
        >
      </ng-template>
    </div>
  </campus-side-sheet-body>

  <campus-side-sheet-page>
    <div class="manage-kabas-tasks-detail"
      ><div class="manage-kabas-tasks-detail__container">
        <div
          class="manage-kabas-tasks-detail__filterbar"
          [class.manage-kabas-tasks-detail__filterbar--disabled]="isReordering"
        >
          <campus-search-term
            placeholder="Filter op titel"
            [autoComplete]="false"
            [emitOnTextChange]="true"
            (valueChange)="searchTermFilterValueChanged($event)"
            class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--title"
          ></campus-search-term>

          <campus-button-toggle-filter
            *ngIf="!task.isPaperTask"
            [multiple]="true"
            [filterCriteria]="requiredFilterCriteria"
            (filterSelectionChange)="requiredFilterSelectionChanged($event)"
            class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--required"
          >
          </campus-button-toggle-filter>

          <campus-button-toggle-filter
            [multiple]="true"
            [filterCriteria]="diaboloPhaseFilterCriteria"
            (filterSelectionChange)="diaboloPhaseFilterSelectionChanged($event)"
            class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--diabolo-phase"
          >
          </campus-button-toggle-filter>

          <campus-button-toggle-filter
            [multiple]="true"
            [filterCriteria]="levelFilterCriteria"
            (filterSelectionChange)="levelFilterSelectionChanged($event)"
            class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--level"
          >
          </campus-button-toggle-filter>

          <campus-button
            class="manage-kabas-tasks-detail__filterbar__reset-filters"
            iconClass="reset-filters"
            (click)="clickResetFilters()"
          ></campus-button>
        </div>

        <div class="manage-kabas-tasks-detail__list__actions">
          <div class="manage-kabas-tasks-detail__list__primary-action">
            <mat-icon svgIcon="add"></mat-icon>
            Lesmateriaal toevoegen aan deze taak
          </div>

          <div class="manage-kabas-tasks-detail__list__reorder-actions">
            <campus-button (click)="toggleIsReordering()" *ngIf="!isReordering"
              >Volgorde wijzigen</campus-button
            >

            <campus-button (click)="toggleIsReordering()" *ngIf="isReordering"
              >Annuleren</campus-button
            >
            <campus-button primary (click)="saveOrder()" *ngIf="isReordering"
              >Opslaan</campus-button
            >
          </div>
        </div>

        <mat-selection-list
          [(ngModel)]="selectedTaskEduContents"
          (ngModelChange)="onSelectionChange()"
          #taskContent
          class="manage-kabas-tasks-detail__list"
          [class.mat-selection-list--has-selection]="
            !taskContent.selectedOptions.isEmpty()
          "
          *ngIf="!isReordering"
        >
          <ng-container
            *ngIf="filteredTaskEduContents$ | async as taskEduContents"
          >
            <ng-container *ngIf="taskEduContents.length; else noResults">
              <mat-list-option
                #option
                *ngFor="let tEC of taskEduContents"
                checkboxPosition="before"
                [class.mat-list-option--selected]="option.selected"
                [value]="tEC"
              >
                <campus-task-edu-content-list-item
                  [title]="tEC.eduContent.publishedEduContentMetadata.title"
                  [level]="
                    tEC.eduContent.methodLevel &&
                    tEC.eduContent.methodLevel.label
                  "
                  [required]="tEC.required"
                  [fileIcon]="
                    tEC.eduContent.publishedEduContentMetadata.fileExt
                  "
                  [diaboloPhaseIcon]="
                    tEC.eduContent.diaboloPhase &&
                    tEC.eduContent.diaboloPhase.icon
                  "
                  [isPaperTask]="task.isPaperTask"
                  [actions]="tEC.actions"
                  (clickAction)="
                    handleTaskEduContentAction($event, tEC.eduContent)
                  "
                >
                </campus-task-edu-content-list-item>
              </mat-list-option>
            </ng-container>
          </ng-container>
        </mat-selection-list>
        <mat-list
          #taskContentReordering
          class="manage-kabas-tasks-detail__list"
          *ngIf="
            isReordering &&
            (reorderableTaskEduContents$ | async) as reorderableTaskEduContents
          "
          cdkDropList
          (cdkDropListDropped)="
            dropTaskEduContent(reorderableTaskEduContents, $event)
          "
        >
          <ng-container
            *ngIf="reorderableTaskEduContents.length; else noResults"
          >
            <mat-list-item
              class="manage-kabas-tasks-detail__list__item"
              cdkDrag
              *ngFor="let tEC of reorderableTaskEduContents"
            >
              <mat-icon
                class="manage-kabas-tasks-detail__list__drag-handle"
                svgIcon="drag-handle"
              ></mat-icon>
              <campus-task-edu-content-list-item
                [title]="tEC.eduContent.publishedEduContentMetadata.title"
                [level]="
                  tEC.eduContent.methodLevel && tEC.eduContent.methodLevel.label
                "
                [required]="tEC.required"
                [isPaperTask]="task.isPaperTask"
                [fileIcon]="tEC.eduContent.publishedEduContentMetadata.fileExt"
                [diaboloPhaseIcon]="
                  tEC.eduContent.diaboloPhase &&
                  tEC.eduContent.diaboloPhase.icon
                "
              >
              </campus-task-edu-content-list-item>
            </mat-list-item>
          </ng-container>
        </mat-list>

        <ng-template #noResults>
          <p>De toegepaste filter bevat geen resultaten.</p>
        </ng-template>
      </div>
    </div>
  </campus-side-sheet-page></campus-side-sheet
>

<campus-page-bar *ngIf="task$ | async as task">
  <ng-container
    *ngIf="selectedTaskEduContents.length === 0; else contentSelected"
  >
    <campus-button
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      routerLink="content"
      ><span>Lesmateriaal toevoegen</span></campus-button
    >
    <campus-button
      *ngIf="!task.isPaperTask"
      class="shared-header__contextual__button smallIcon"
      iconClass="results"
      ><span>Resultaten bekijken</span></campus-button
    >
    <campus-button
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      ><span>Doelenmatrix</span></campus-button
    >
    <campus-button
      *ngIf="task.isPaperTask"
      class="shared-header__contextual__button smallIcon"
      iconClass="print"
      (click)="clickPrintTask()"
      ><span>Print</span></campus-button
    >
  </ng-container>

  <ng-template #contentSelected>
    <campus-button
      inline
      *ngIf="selectedTaskEduContents.length === 1"
      class="shared-header__contextual__button"
      (click)="
        preview(selectedTaskEduContents[0].eduContent, !!task.isPaperTask)
      "
      ><mat-icon svgIcon="eye"></mat-icon
      >{{ task.isPaperTask ? 'Voorbeeld' : 'Openen' }}</campus-button
    >
    <campus-button
      *ngIf="task.isPaperTask"
      class="shared-header__contextual__button smallIcon"
      iconClass=""
      ><span>Print</span></campus-button
    >
    <campus-button
      class="shared-header__contextual__button smallIcon"
      iconClass="delete"
      (click)="clickRemoveTaskEduContents(selectedTaskEduContents)"
      ><span>Verwijderen</span></campus-button
    >
  </ng-template>
</campus-page-bar>

<campus-backdrop [title]="(task$ | async)?.name" static>
  <backdrop-reveal-action>
    <mat-icon svgIcon="arrow-back" (click)="clickBack()"></mat-icon>
  </backdrop-reveal-action>
  <front-layer-content>
    <div
      class="manage-kabas-tasks-detail__container"
      *ngIf="task$ | async as task; else noTask"
      #taskSidesheet
    >
      <campus-section
        [mode]="sectionModes.CONTAINER"
        class="manage-kabas-tasks-detail__main"
      >
        <section-title> Lesmateriaal in {{ task.name }} </section-title>
        <section-actions>
          <campus-button
            bordered
            flat
            icon
            dense
            [disabled]="isReordering || !task.taskEduContents.length"
            (click)="showFilters = !showFilters"
            ><mat-icon svgIcon="filter"></mat-icon
          ></campus-button>
        </section-actions>

        <section-content>
          <div class="manage-kabas-tasks-detail">
            <div
              class="manage-kabas-tasks-detail__filterbar"
              [hidden]="!showFilters || isReordering"
            >
              <div class="manage-kabas-tasks-detail__filterbar__filters">
                <campus-search-term
                  placeholder="Filter op titel"
                  [autoComplete]="false"
                  [emitOnTextChange]="true"
                  (valueChange)="searchTermFilterValueChanged($event)"
                  class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--title"
                ></campus-search-term>

                <campus-button-toggle-filter
                  *ngIf="!task.isPaperTask"
                  [multiple]="true"
                  [filterCriteria]="requiredFilterCriteria"
                  (filterSelectionChange)="
                    requiredFilterSelectionChanged($event)
                  "
                  class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--required"
                >
                </campus-button-toggle-filter>

                <campus-button-toggle-filter
                  [multiple]="true"
                  [filterCriteria]="diaboloPhaseFilterCriteria"
                  (filterSelectionChange)="
                    diaboloPhaseFilterSelectionChanged($event)
                  "
                  class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--diabolo-phase"
                >
                </campus-button-toggle-filter>

                <campus-button-toggle-filter
                  [multiple]="true"
                  [filterCriteria]="levelFilterCriteria"
                  (filterSelectionChange)="levelFilterSelectionChanged($event)"
                  class="manage-kabas-tasks-detail__filterbar__filter manage-kabas-tasks-detail__filterbar__filter--level"
                >
                </campus-button-toggle-filter>

                <campus-button
                  bordered
                  flat
                  icon
                  class="manage-kabas-tasks-detail__filterbar__reset-filters"
                  iconClass="reset-filters"
                  (click)="clickResetFilters()"
                ></campus-button>
              </div>
            </div>
            <ng-container *ngIf="task.taskEduContents.length; else noContent">
              <ng-container
                *ngIf="filteredTaskEduContents$ | async as taskEduContents"
              >
                <div class="manage-kabas-tasks-detail__list__actions">
                  <campus-button
                    fab
                    icon
                    routerLink="content"
                    class="manage-kabas-tasks-detail__list__primary-action"
                    *ngIf="taskEduContents.length"
                  >
                    <mat-icon svgIcon="add"></mat-icon>
                  </campus-button>
                  <div
                    class="manage-kabas-tasks-detail__list__reorder-actions"
                    *ngIf="!showFilters && taskEduContents.length"
                  >
                    <campus-button
                      bordered
                      flat
                      (click)="toggleIsReordering()"
                      *ngIf="!isReordering"
                      >Volgorde wijzigen</campus-button
                    >

                    <campus-button
                      bordered
                      flat
                      (click)="toggleIsReordering()"
                      *ngIf="isReordering"
                      >Annuleren</campus-button
                    >
                    <campus-button
                      secondary
                      (click)="saveOrder()"
                      *ngIf="isReordering"
                      >Opslaan</campus-button
                    >
                  </div>
                </div>

                <mat-selection-list
                  [(ngModel)]="selectedTaskEduContents"
                  (ngModelChange)="onSelectionChange()"
                  #taskContent
                  class="manage-kabas-tasks-detail__list"
                  data-cy="task-edu-contents-list"
                  [class.mat-selection-list--has-selection]="
                    !taskContent.selectedOptions.isEmpty()
                  "
                  *ngIf="!isReordering"
                >
                  <ng-container *ngIf="taskEduContents.length; else noResults">
                    <mat-list-option
                      #option
                      *ngFor="let tEC of taskEduContents"
                      checkboxPosition="before"
                      class="ui-list-item-3-line"
                      [class.mat-list-option--selected]="option.selected"
                      [value]="tEC"
                    >
                      <campus-task-edu-content-list-item
                        [title]="
                          tEC.eduContent.publishedEduContentMetadata.title
                        "
                        [description]="
                          tEC.eduContent.publishedEduContentMetadata.description
                        "
                        [level]="
                          tEC.eduContent.methodLevel &&
                          tEC.eduContent.methodLevel.label
                        "
                        [required]="tEC.required"
                        [fileIcon]="
                          tEC.eduContent.publishedEduContentMetadata.fileExt
                        "
                        [diaboloPhaseIcon]="
                          tEC.eduContent.diaboloPhase &&
                          tEC.eduContent.diaboloPhase.icon
                        "
                        [isPaperTask]="task.isPaperTask"
                        [actions]="tEC.actions"
                        (clickAction)="
                          handleTaskEduContentAction($event, tEC.eduContent)
                        "
                      >
                      </campus-task-edu-content-list-item>
                    </mat-list-option>
                  </ng-container>
                </mat-selection-list>
              </ng-container>

              <mat-list
                #taskContentReordering
                class="manage-kabas-tasks-detail__list manage-kabas-tasks-detail__list--reorderable"
                *ngIf="
                  isReordering &&
                  (reorderableTaskEduContents$
                    | async) as reorderableTaskEduContents
                "
                cdkDropList
                (cdkDropListDropped)="
                  dropTaskEduContent(reorderableTaskEduContents, $event)
                "
              >
                <ng-container
                  *ngIf="reorderableTaskEduContents.length; else noResults"
                >
                  <mat-list-item
                    class="manage-kabas-tasks-detail__list__item ui-list-item-3-line"
                    cdkDrag
                    *ngFor="let tEC of reorderableTaskEduContents"
                  >
                    <mat-icon
                      class="manage-kabas-tasks-detail__list__drag-handle"
                      svgIcon="drag-handle"
                    ></mat-icon>
                    <campus-task-edu-content-list-item
                      [title]="tEC.eduContent.publishedEduContentMetadata.title"
                      [level]="
                        tEC.eduContent.methodLevel &&
                        tEC.eduContent.methodLevel.label
                      "
                      [required]="tEC.required"
                      [isPaperTask]="task.isPaperTask"
                      [fileIcon]="
                        tEC.eduContent.publishedEduContentMetadata.fileExt
                      "
                      [diaboloPhaseIcon]="
                        tEC.eduContent.diaboloPhase &&
                        tEC.eduContent.diaboloPhase.icon
                      "
                    >
                    </campus-task-edu-content-list-item>
                  </mat-list-item>
                </ng-container>
              </mat-list>

              <ng-template #noResults>
                <campus-empty-state
                  title="Geen resultaten gevonden"
                  svgIcon="empty-state-no-educontent"
                ></campus-empty-state>
              </ng-template>
            </ng-container>
            <ng-template #noContent>
              <campus-empty-state
                title="Geen lesmateriaal"
                [description]="
                  'Er werd nog geen lesmateriaal toegevoegd aan ' +
                  task.name +
                  '.'
                "
                ctaLabel="Lesmateriaal toevoegen"
                (clickCta)="clickAddContent()"
                svgIcon="empty-state-no-educontent"
              ></campus-empty-state>
            </ng-template>
          </div>
        </section-content>
      </campus-section>

      <campus-section
        [mode]="sectionModes.CONTAINER"
        class="manage-kabas-tasks-detail__side"
      >
        <section-title>
          <ng-container [ngSwitch]="selectedTaskEduContents.length">
            <ng-container *ngSwitchCase="0">Over deze taak</ng-container>
            <ng-container *ngSwitchDefault>Over dit lesmateriaal</ng-container>
          </ng-container>
        </section-title>

        <section-content>
          <div class="manage-kabas-tasks-detail__info">
            <ng-container
              *ngIf="selectedTaskEduContents.length === 0; else contentDetails"
            >
              <!-- GENERAL SECTION -->
              <campus-section
                [(mode)]="sectionMode"
                (modeChange)="updateCachedTask(task)"
              >
                <section-title>Algemeen</section-title>
                <section-actions
                  ><mat-icon svgIcon="edit"></mat-icon
                ></section-actions>

                <section-content>
                  <div *ngIf="sectionMode === sectionModes.EDITABLE">
                    <p data-cy="task-title" class="ui-body-2">{{
                      task.name
                    }}</p>
                    <p class="ui-body-1">{{ task.description }}</p>
                    <p class="ui-body-1">{{ task.learningArea.name }} </p>
                  </div>

                  <div *ngIf="sectionMode === sectionModes.EDITING">
                    <mat-form-field>
                      <mat-label>Taak titel</mat-label>
                      <input
                        matInput
                        type="text"
                        maxlength="500"
                        required
                        [(ngModel)]="taskCache.name"
                      />
                    </mat-form-field>
                    <mat-form-field>
                      <mat-label>Taak omschrijving</mat-label>
                      <textarea
                        matInput
                        maxlength="500"
                        cdkTextareaAutosize
                        [(ngModel)]="taskCache.description"
                      ></textarea>
                    </mat-form-field>

                    <campus-button inline disabled>
                      <mat-icon
                        svgIcon="lock"
                        *ngIf="sectionMode === sectionModes.EDITING"
                      ></mat-icon
                      >{{ task.learningArea.name }}
                    </campus-button>

                    <section-footer-actions>
                      <campus-button bordered flat (click)="cancelEdit($event)"
                        >Annuleren</campus-button
                      >
                      <campus-button
                        secondary
                        [disabled]="!taskCache.name"
                        (click)="editTask($event)"
                        >Opslaan</campus-button
                      >
                    </section-footer-actions>
                  </div>
                </section-content>
              </campus-section>

              <!-- ASSIGNEE SECTION -->
              <campus-section (actionClick)="openAssigneeModal()">
                <section-title>Toegewezen aan</section-title>

                <section-actions>
                  <campus-button icon bordered dense flat>
                    <mat-icon svgIcon="add"></mat-icon>
                  </campus-button>
                </section-actions>

                <section-content>
                  <div class="manage-kabas-tasks-detail__info__container">
                    <mat-chip-list>
                      <mat-chip
                        *ngFor="let assignee of task.assignees"
                        class="manage-kabas-tasks-detail__info__assignee"
                        [matTooltip]="
                          (assignee.start | date: 'dd-MM-yy') +
                          ' - ' +
                          (assignee.end | date: 'dd-MM-yy')
                        "
                        [class.classgroup]="
                          assignee.type === assigneeTypesEnum.CLASSGROUP
                        "
                        [class.group]="
                          assignee.type === assigneeTypesEnum.GROUP
                        "
                        [class.student]="
                          assignee.type === assigneeTypesEnum.STUDENT
                        "
                        [removable]="true"
                        (removed)="removeAssignee(task, assignee)"
                        >{{ assignee.label }}
                        <mat-icon matChipRemove svgIcon="cancel"></mat-icon>
                      </mat-chip>
                    </mat-chip-list>
                    <campus-empty-state
                      *ngIf="task.assignees.length === 0"
                      [dense]="true"
                      [horizontal]="true"
                      svgIcon="empty-state-no-users"
                      description="Deze taak is nog aan niemand toegewezen"
                    ></campus-empty-state>
                  </div>

                  <div
                    *ngIf="!task.isPaperTask && task.startDate"
                    data-cy="task-info-date"
                    class="ui-body-2"
                  >
                    <hr />
                    {{ task.startDate | date: 'dd-MM-yy' }} -
                    {{ task.endDate | date: 'dd-MM-yy' }}</div
                  >
                </section-content>
              </campus-section>

              <!-- ACTIONS SECTION -->
              <campus-section>
                <section-content class="manage-kabas-tasks-detail__actions">
                  <div>
                    <campus-button inline routerLink="content">
                      <mat-icon svgIcon="add"></mat-icon>
                      Lesmateriaal toevoegen
                    </campus-button>
                  </div>
                  <ng-container *ngIf="task.isPaperTask">
                    <div
                      [matTooltip]="
                        !task.assignees.length
                          ? 'Deze taak is aan niemand toegekend.'
                          : ''
                      "
                      matTooltipPosition="before"
                    >
                      <campus-button
                        inline
                        (click)="printTask(task, true)"
                        [disabled]="!task.assignees.length"
                        class="manage-kabas-tasks-detail__info__link-print"
                      >
                        <mat-icon svgIcon="print"></mat-icon>
                        Afdrukken met namen
                      </campus-button>
                    </div>
                    <div>
                      <campus-button
                        inline
                        (click)="printTask(task, false)"
                        class="manage-kabas-tasks-detail__info__link-print"
                      >
                        <mat-icon svgIcon="print"></mat-icon>
                        Afdrukken zonder namen
                      </campus-button>
                    </div>
                    <div
                      [matTooltip]="
                        !task.hasSolutionFiles
                          ? 'Het lesmateriaal in deze taak bevat geen correctiesleutels.'
                          : ''
                      "
                      matTooltipPosition="before"
                    >
                      <campus-button
                        inline
                        (click)="printSolution(task)"
                        [disabled]="!task.hasSolutionFiles"
                        class="manage-kabas-tasks-detail__info__link-print"
                      >
                        <mat-icon svgIcon="print"></mat-icon>
                        Correctiesleutel afdrukken
                      </campus-button>
                    </div>
                  </ng-container>

                  <hr />
                  <campus-button
                    danger
                    inline
                    (click)="clickDeleteTask(task)"
                    [disabled]="isActiveTask(task)"
                  >
                    <mat-icon svgIcon="delete"></mat-icon>
                    Verwijder taak
                  </campus-button>
                </section-content>
              </campus-section>
            </ng-container>

            <ng-template #contentDetails>
              <campus-section static>
                <section-content>
                  <div
                    class="manage-kabas-tasks-detail__info__container"
                    *ngFor="let selectedContent of selectedTaskEduContents"
                    data-cy="educontent-detail"
                  >
                    <ng-container
                      *ngIf="
                        selectedContent.eduContent
                          .publishedEduContentMetadata as metadata
                      "
                    >
                      <p class="ui-body-2">{{ metadata.title }}</p>
                      <p class="ui-body-1">{{ metadata.description }}</p>
                      <p class="ui-body-1" *ngIf="metadata.learningArea">{{
                        metadata.learningArea.name
                      }}</p>
                      <div *ngIf="metadata.methods" class="list-split">
                        <span
                          class="ui-caption"
                          *ngFor="let method of metadata.methods"
                          >{{ method.name }}</span
                        >
                      </div>
                      <campus-button
                        inline
                        (click)="
                          preview(
                            selectedContent.eduContent,
                            !!task.isPaperTask
                          )
                        "
                      >
                        <mat-icon svgIcon="preview"></mat-icon>
                        Voorbeeld
                      </campus-button>
                      <hr />
                    </ng-container>
                  </div>

                  <div
                    *ngIf="!task.isPaperTask"
                    class="manage-kabas-tasks-detail__info__container"
                  >
                    <mat-radio-group
                      class="manage-kabas-tasks-detail__info__required"
                      *ngIf="
                        selectedTaskEduContents.length === 1;
                        else multipleSelected
                      "
                      [value]="selectedTaskEduContents[0].required"
                      (change)="
                        setTaskEduContentsRequiredState(
                          selectedTaskEduContents,
                          $event.value
                        )
                      "
                    >
                      <mat-radio-button
                        [checked]="selectedTaskEduContents[0].required"
                        [value]="true"
                        >Moetje</mat-radio-button
                      >
                      <br /><mat-radio-button
                        [checked]="!selectedTaskEduContents[0].required"
                        [value]="false"
                        >Magje</mat-radio-button
                      >
                    </mat-radio-group>
                    <ng-template #multipleSelected>
                      <campus-button
                        bordered
                        dense
                        flat
                        (click)="
                          setTaskEduContentsRequiredState(
                            selectedTaskEduContents,
                            true
                          )
                        "
                        >Alles moetje</campus-button
                      >
                      <campus-button
                        bordered
                        dense
                        flat
                        (click)="
                          setTaskEduContentsRequiredState(
                            selectedTaskEduContents,
                            false
                          )
                        "
                        >Alles magje</campus-button
                      >
                    </ng-template>

                    <hr />
                  </div>

                  <campus-button
                    danger
                    inline
                    [disabled]="isActiveTask(task)"
                    (click)="
                      clickRemoveTaskEduContents(selectedTaskEduContents)
                    "
                    ><mat-icon svgIcon="delete"></mat-icon> Verwijder
                    lesmateriaal</campus-button
                  >
                </section-content>
              </campus-section>
            </ng-template>
          </div>
        </section-content>
      </campus-section>
    </div>
    <ng-template #noTask>
      <!-- TODO: change to new task empty state -->
      <campus-empty-state
        svgIcon="empty-state-no-educontent"
      ></campus-empty-state>
    </ng-template>
  </front-layer-content>
</campus-backdrop>
